<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PD-Simulatie | Briefing & Oefening</title>
    <style>
        :root { 
            --police-blue: #003366; 
            --gold: #FFD700; 
            --bg: #f4f7f9; 
            --white: #ffffff;
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .page { display: none; height: 100%; width: 100%; }
        .active { display: flex; }

        /* Login Scherm */
        #page-login { 
            justify-content: center; 
            align-items: center; 
            background: linear-gradient(135deg, var(--police-blue) 0%, #001a33 100%); 
        }
        .briefing-card { 
            background: white; 
            color: #333; 
            padding: 30px; 
            border-radius: 8px; 
            width: 90%;
            max-width: 600px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .stap-box { background: #eef2f7; padding: 15px; border-left: 5px solid var(--police-blue); margin: 15px 0; }
        .eisen-lijst { font-size: 14px; line-height: 1.5; background: #fffdf0; padding: 15px; border: 1px solid #f1e0a1; border-radius: 4px; }

        /* Simulator Interface */
        #page-sim.active { display: grid; grid-template-columns: 1fr 400px; }
        #foto-container { position: relative; background-size: cover; background-position: center; flex-grow: 1; background-color: #000; }
        
        /* Blur effect */
        .unit-view-locked { filter: blur(40px) brightness(0.7); }
        
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #oc-panel { pointer-events: auto !important; }

        /* Sidebar & Feed */
        #sidebar { background: var(--white); border-left: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; }
        #livefeed { flex-grow: 1; overflow-y: auto; padding: 15px; background: #fdfdfd; }
        .melding { background: white; border: 1px solid #e0e0e0; padding: 12px; margin-bottom: 10px; border-left: 5px solid #ccc; font-size: 14px; }
        .melding-fb { border-left-color: var(--gold); background: #fffde7; }
        
        /* Input & Buttons */
        #input-area { padding: 15px; border-top: 1px solid #ddd; background: white; }
        textarea { width: 100%; border: 1px solid #ccc; padding: 10px; resize: none; font-family: inherit; border-radius: 4px; }
        .btn { background: var(--police-blue); color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 4px; margin-top: 10px; }
        .btn-oc { background: #444; }

        #oc-controls { position: absolute; top: 20px; left: 20px; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; }
    </style>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="briefing-card">
            <h2 style="color: var(--police-blue); margin-top: 0;">Briefing PD-Simulatie</h2>
            
            <div class="stap-box">
                <strong>Stap 1: De blur verwijderen</strong><br>
                Beschrijf je positie en het kale decor. De simulatie start wazig.
                Start altijd met: <strong>"Ik stond..."</strong>
            </div>

            <div class="eisen-lijst">
                <strong>Eisen voor de melding:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><strong>Tijd:</strong> Kaal decor = tegenwoordige tijd. Sporen = verleden tijd.</li>
                    <li><strong>Objectief:</strong> GEEN namen (geen pistool, bloed, huls).</li>
                    <li><strong>Kenmerken:</strong> Beschrijf vorm, kleur, materiaal en grootte.</li>
                    <li><strong>Geen waarneming:</strong> Gebruik geen 'zie/zag/kijk'.</li>
                </ul>
            </div>

            <div style="margin-top: 25px;">
                <label><strong>Naam Verbalisant:</strong></label>
                <input type="text" id="userName" placeholder="Achternaam / Unit" style="width:100%; padding:12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;">
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="startApp('UNIT')" class="btn">START ALS EENHEID</button>
                    <button onclick="startApp('OC')" class="btn btn-oc">OC LOGIN</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-sim" class="page">
        <div id="foto-container">
            <div id="canvas"></div>
            
            <div id="oc-controls" style="display:none;">
                <strong>OC PANEEL</strong><hr>
                <div id="sporen-knoppen"></div>
                <button onclick="vrijgeven()" style="background: #2ecc71; color: white; border: none; padding: 10px; width: 100%; margin-top: 10px; cursor: pointer;">ðŸ”“ VRIJGEVEN (Blur uit)</button>
                <button onclick="resetSim()" style="background: #e74c3c; color: white; border: none; padding: 5px; width: 100%; margin-top: 5px; cursor: pointer; font-size: 10px;">RESET ALLES</button>
            </div>
        </div>

        <div id="sidebar">
            <div id="livefeed"></div>
            <div id="input-area">
                <textarea id="msgInput" rows="4" placeholder="Typ je melding..."></textarea>
                <button class="btn" onclick="verstuurMelding()">VERSTUUR MELDING</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, update, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB12mTMBnuxdC4W4htyFO_C7Dnh3maVKew",
        authDomain: "decoroefening.firebaseapp.com",
        databaseURL: "https://decoroefening-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "decoroefening"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName, myRole, myView = "";

    const sporen = [
        { id: 'A', name: 'Spoor A', img: '9mm pistol top down.png', size: 110 },
        { id: 'B', name: 'Spoor B', img: 'Bullet casing isolated.png', size: 30 },
        { id: 'C', name: 'Spoor C', img: 'Blood splatter top view.png', size: 150 },
        { id: 'D', name: 'Spoor D', img: 'Shoe print texture.png', size: 90 }
    ];

    window.startApp = (role) => {
        const n = document.getElementById('userName').value.trim();
        if(!n) return alert("Vul je naam in.");
        
        myName = n;
        myRole = role;

        document.getElementById('page-login').classList.remove('active');
        document.getElementById('page-sim').classList.add('active');

        const container = document.getElementById('foto-container');
        if(role === 'OC') {
            container.style.backgroundImage = "url('noord.jpg')";
            document.getElementById('oc-controls').style.display = 'block';
            renderOCKnoppen();
        } else {
            const fotos = ['noord.jpg', 'oost.jpg', 'zuid.jpg', 'west.jpg'];
            myView = fotos[Math.floor(Math.random() * fotos.length)];
            container.style.backgroundImage = `url('${myView}')`;
            container.classList.add('unit-view-locked');
        }

        startListeners();
    };

    function renderOCKnoppen() {
        const div = document.getElementById('sporen-knoppen');
        sporen.forEach(s => {
            const b = document.createElement('button');
            b.innerText = s.name;
            b.style.margin = "2px";
            b.onclick = () => set(ref(db, 'sporen/' + s.id), { x: 50, y: 50, r: 0 });
            div.appendChild(b);
        });
    }

    window.verstuurMelding = () => {
        const input = document.getElementById('msgInput');
        const txt = input.value.trim();
        const low = txt.toLowerCase();

        if(!low.startsWith("ik stond")) return alert("Start met: 'Ik stond...'");
        
        const verboden = ['zie','zag','kijk','pistool','bloed','huls','wapen'];
        for(let v of verboden) { if(low.includes(v)) return alert("Protocolfout: Woord '" + v + "' is niet toegestaan."); }

        if(txt) {
            push(ref(db, 'feed'), { sender: myName, msg: txt, role: myRole, view: myView.replace('.jpg','').toUpperCase() });
            input.value = '';
        }
    };

    function startListeners() {
        // Luister naar sporen
        onValue(ref(db, 'sporen'), (snap) => {
            const data = snap.val() || {};
            onValue(ref(db, 'vrijgave'), (v) => {
                const vrij = v.val();
                document.querySelectorAll('.spoor-item').forEach(e => e.remove());
                sporen.forEach(s => {
                    if(data[s.id] && (myRole === 'OC' || vrij)) {
                        const div = document.createElement('div');
                        div.className = 'spoor spoor-item';
                        div.style.left = data[s.id].x + '%';
                        div.style.top = data[s.id].y + '%';
                        div.innerHTML = `<img src="${s.img}" style="width:${s.size}px; transform:rotate(${data[s.id].r}deg)"><div style="background:black; color:white; font-size:10px; padding:2px;">${s.name}</div>`;
                        document.getElementById('canvas').appendChild(div);
                    }
                });
            });
        });

        // Luister naar feed
        onValue(ref(db, 'feed'), (snap) => {
            const feed = document.getElementById('livefeed');
            feed.innerHTML = '';
            let items = [];
            snap.forEach(c => items.push(c.val()));
            items.reverse().forEach(m => {
                const isFb = m.role === 'FEEDBACK';
                feed.innerHTML += `<div class="melding ${isFb ? 'melding-fb' : ''}"><strong>${m.sender} [${m.view || 'OC'}]</strong>${m.msg}</div>`;
            });
        });

        // Luister naar vrijgave (blur)
        onValue(ref(db, 'vrijgave'), (snap) => {
            if(snap.val() && myRole === 'UNIT') {
                document.getElementById('foto-container').classList.remove('unit-view-locked');
            }
        });
    }

    window.vrijgeven = () => set(ref(db, 'vrijgave'), true);
    window.resetSim = () => { if(confirm("Resetten?")) { remove(ref(db, 'sporen')); remove(ref(db, 'feed')); set(ref(db, 'vrijgave'), false); location.reload(); }};
</script>
</body>
</html>
