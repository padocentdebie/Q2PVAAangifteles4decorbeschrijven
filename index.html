<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PD Decor Oefening - Briefing</title>
    <style>
        :root {
            --police-blue: #003366;
            --gold: #FFD700;
            --white: #ffffff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        
        .page { display: none; height: 100%; }
        .active { display: flex; flex-direction: column; }

        /* Login / Briefing Blad */
        #page-login { 
            justify-content: center; 
            align-items: center; 
            background: var(--police-blue); 
            color: white; 
            padding: 20px;
        }
        .briefing-card {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .briefing-card h2 { color: var(--police-blue); margin-top: 0; border-bottom: 2px solid var(--gold); padding-bottom: 10px; }
        .regels { background: #fffde7; border-left: 4px solid var(--gold); padding: 15px; margin: 15px 0; font-size: 0.9em; }
        .regels ul { padding-left: 20px; }

        /* Simulaatieruimte */
        #page-sim.active { display: grid; grid-template-columns: 1fr 380px; }
        #foto-container { position: relative; background-size: cover; background-position: center; flex-grow: 1; transition: filter 0.5s; background-color: #000; }
        .unit-view-locked { filter: blur(20px); pointer-events: none; }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }

        /* Sporen */
        .spoor { position: absolute; cursor: move; display: flex; flex-direction: column; align-items: center; transform: translate(-50%, -50%); z-index: 10; }
        .spoor img { pointer-events: none; user-select: none; }
        .spoor-label { background: rgba(0,30,60,0.8); color: white; padding: 2px 6px; font-size: 11px; border-radius: 3px; margin-top: 5px; }

        /* Sidebar & Feed */
        #sidebar { background: #e0e0e0; border-left: 1px solid #bbb; display: flex; flex-direction: column; }
        #livefeed { flex-grow: 1; overflow-y: auto; padding: 15px; background: #fdfdfd; }
        .melding { background: white; border-left: 5px solid #bdc3c7; padding: 12px; margin-bottom: 12px; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .melding-oc { border-left-color: var(--police-blue); background: #e3f2fd; }
        .melding-fb { border-left-color: var(--gold); background: #fff9c4; font-style: italic; }
        .badge-view { background: #555; color: white; padding: 2px 5px; font-size: 10px; border-radius: 3px; margin-left: 8px; font-weight: bold; }
        
        /* Input */
        #input-area { padding: 15px; background: #eee; border-top: 1px solid #ccc; }
        #msgInput { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; }
        .btn-send { background: var(--police-blue); color: white; border: none; padding: 12px; width: 100%; cursor: pointer; margin-top: 5px; border-radius: 4px; font-weight: bold; }
        .btn-send:hover { background: #002244; }

        /* OC Controls */
        #oc-panel { background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; position: absolute; bottom: 20px; left: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; }
        .spoor-btn { margin: 3px; padding: 6px 10px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 4px; }
        .spoor-btn:hover { background: #f0f0f0; }
        .feedback-btn { float: right; font-size: 11px; padding: 2px 6px; cursor: pointer; background: #eee; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="briefing-card">
            <h2>üö® PD Beschrijving Oefening</h2>
            <p>Welkom bij de simulatie. Voordat je start, herhaal de regels voor de <strong>decorbeschrijving</strong>:</p>
            
            <div class="regels">
                <strong>HET PARADIGMA:</strong>
                <ul>
                    <li>Beschrijf <strong>objectief</strong> wat er aanwezig is.</li>
                    <li>Gebruik <strong>GEEN</strong> persoonlijke woorden (ik, mij, wij, ons).</li>
                    <li>Gebruik <strong>GEEN</strong> waarnemingswerkwoorden (zie, zag, kijken).</li>
                    <li><em>Fout:</em> "Ik zie een mes op de grond."</li>
                    <li><em>Goed:</em> "Op de vloer bevindt zich een mes."</li>
                </ul>
            </div>

            <label for="userName"><strong>Naam / Eenheid nummer:</strong></label><br>
            <input type="text" id="userName" placeholder="bijv. Sectie 1 - Jansen" style="width:100%; padding:10px; margin: 10px 0; box-sizing: border-box; border: 1px solid #ccc;">
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="startApp('UNIT')" style="flex:2; padding: 15px; background: var(--police-blue); color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">START ALS EENHEID</button>
                <button onclick="startApp('OC')" style="flex:1; padding: 15px; background: #666; color:white; border:none; border-radius:4px; cursor:pointer;">OC LOGIN</button>
            </div>
        </div>
    </div>

    <div id="page-sim" class="page">
        <div id="foto-container">
            <div id="canvas"></div>
            
            <div id="oc-panel" style="display:none;">
                <strong>üõ† OC BEHEER</strong><hr>
                <div id="sporen-toolbar"></div>
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <button onclick="vrijgevenDecor()" style="background:#2ecc71; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; flex:1;">üîì Vrijgeven aan Units</button>
                    <button onclick="resetOefening()" style="background:#e74c3c; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">‚ö†Ô∏è Reset</button>
                </div>
            </div>
        </div>

        <div id="sidebar">
            <div id="livefeed"></div>
            <div id="input-area">
                <textarea id="msgInput" rows="3" placeholder="Typ hier de decorbeschrijving volgens het paradigma..."></textarea>
                <button class="btn-send" onclick="sendMsg()">MELDING VERSTUREN</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, update, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB12mTMBnuxdC4W4htyFO_C7Dnh3maVKew",
        authDomain: "decoroefening.firebaseapp.com",
        databaseURL: "https://decoroefening-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "decoroefening",
        storageBucket: "decoroefening.firebasestorage.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName, myRole, mijnAanzicht = "";

    const sporenLijst = [
        { id: 'pistool', name: 'Pistool', img: '9mm pistol top down.jpg', size: 100 },
        { id: 'huls', name: 'Huls', img: 'Bullet casing isolated.png', size: 30 },
        { id: 'bloed', name: 'Bloed', img: 'Blood splatter top view.jpg', size: 150 },
        { id: 'schoen', name: 'Schoenafdruk', img: 'Shoe print texture.png', size: 80 }
    ];

    window.startApp = (role) => {
        const nameInput = document.getElementById('userName').value.trim();
        if(!nameInput) { alert("Vul eerst je naam in."); return; }
        
        myName = nameInput;
        myRole = role;
        
        document.getElementById('page-login').classList.remove('active');
        document.getElementById('page-sim').classList.add('active');

        const container = document.getElementById('foto-container');
        
        if(role === 'OC') {
            container.style.backgroundImage = "url('noord.jpg')"; 
            document.getElementById('oc-panel').style.display = 'block';
            setupOCToolbar();
        } else {
            const fotos = ['noord.jpg', 'oost.jpg', 'zuid.jpg', 'west.jpg'];
            mijnAanzicht = fotos[Math.floor(Math.random() * fotos.length)];
            container.style.backgroundImage = `url('${mijnAanzicht}')`;
            container.classList.add('unit-view-locked');
        }

        listenToSporen();
        listenToFeed();
        listenToDecorStatus();
    };

    function setupOCToolbar() {
        const tb = document.getElementById('sporen-toolbar');
        tb.innerHTML = '';
        sporenLijst.forEach(s => {
            const b = document.createElement('button');
            b.className = 'spoor-btn';
            b.innerText = `‚ûï ${s.name}`;
            b.onclick = () => set(ref(db, 'positions/' + s.id), { x: 50, y: 50, r: 0 });
            tb.appendChild(b);
        });
    }

    function listenToSporen() {
        onValue(ref(db, 'positions'), (snapshot) => {
            const data = snapshot.val() || {};
            const container = document.getElementById('foto-container');
            
            // Verwijder sporen die niet meer in DB staan (voor reset)
            document.querySelectorAll('.spoor').forEach(el => {
                const id = el.id.replace('spoor-', '');
                if(!data[id]) el.remove();
            });

            sporenLijst.forEach(s => {
                const pos = data[s.id];
                if(pos) {
                    let el = document.getElementById('spoor-' + s.id);
                    if(!el) {
                        el = document.createElement('div');
                        el.id = 'spoor-' + s.id;
                        el.className = 'spoor';
                        el.innerHTML = `<img src="${s.img}" style="width:${s.size}px"><div class="spoor-label">${s.name}</div>`;
                        document.getElementById('canvas').appendChild(el);
                        if(myRole === 'OC') setupDrag(el, s.id);
                    }
                    el.style.left = pos.x + '%';
                    el.style.top = pos.y + '%';
                    el.querySelector('img').style.transform = `rotate(${pos.r || 0}deg)`;
                    el.style.display = (myRole === 'UNIT' && container.classList.contains('unit-view-locked')) ? 'none' : 'flex';
                }
            });
        });
    }

    function setupDrag(el, id) {
        el.onmousedown = (e) => {
            if(e.button === 2) { 
                onValue(ref(db, 'positions/' + id), (snap) => {
                    const currentR = snap.val().r || 0;
                    update(ref(db, 'positions/' + id), { r: (currentR + 45) % 360 });
                }, { onlyOnce: true });
                return;
            }
            const move = (ev) => {
                const rect = document.getElementById('canvas').getBoundingClientRect();
                update(ref(db, 'positions/' + id), { 
                    x: Math.max(0, Math.min(100, ((ev.clientX - rect.left) / rect.width) * 100)),
                    y: Math.max(0, Math.min(100, ((ev.clientY - rect.top) / rect.height) * 100))
                });
            };
            document.onmousemove = move;
            document.onmouseup = () => document.onmousemove = null;
        };
        el.oncontextmenu = (e) => e.preventDefault();
    }

    window.sendMsg = () => {
        const input = document.getElementById('msgInput');
        const msg = input.value.trim();
        const verboden = /\b(ik|me|mijn|je|jij|jou|jouw|zie|zag|wij|ons|ziet|bekijk|kijk)\b/gi;
        
        if(verboden.test(msg)) {
            alert("‚ö†Ô∏è PARADIGMA FOUT: Gebruik geen persoonlijke voornaamwoorden of waarnemingswerkwoorden. Beschrijf objectief wat er aanwezig is.");
            return;
        }

        if(msg) {
            push(ref(db, 'feed'), { 
                sender: myName, 
                msg: msg, 
                role: myRole, 
                view: mijnAanzicht ? mijnAanzicht.replace('.jpg', '').toUpperCase() : "CENTER",
                timestamp: serverTimestamp() 
            });
            input.value = '';
        }
    };

    window.replyFeedback = (user) => {
        const fb = prompt(`Feedback voor ${user}:`);
        if(fb) {
            push(ref(db, 'feed'), { sender: `OC FEEDBACK (@${user})`, msg: fb, role: 'FEEDBACK', timestamp: serverTimestamp() });
        }
    }

    function listenToFeed() {
        onValue(ref(db, 'feed'), (snapshot) => {
            const feed = document.getElementById('livefeed');
            feed.innerHTML = '';
            const msgs = [];
            snapshot.forEach(child => msgs.push(child.val()));
            msgs.reverse().forEach(m => {
                const cl = m.role === 'OC' ? 'melding-oc' : (m.role === 'FEEDBACK' ? 'melding-fb' : '');
                const viewBadge = m.view ? `<span class="badge-view">${m.view}</span>` : "";
                feed.innerHTML += `
                    <div class="melding ${cl}">
                        ${myRole === 'OC' ? `<button class="feedback-btn" onclick="replyFeedback('${m.sender}')">REAGEER</button>` : ''}
                        <strong>${m.sender}</strong> ${viewBadge}<br>${m.msg}
                    </div>`;
            });
        });
    }

    window.vrijgevenDecor = () => {
        set(ref(db, 'decorVrij'), true);
        alert("Het decor is nu scherp en de sporen zijn zichtbaar voor de eenheden.");
    };

    window.resetOefening = () => {
        if(confirm("Weet je zeker dat je alle sporen en de feed wilt wissen?")) {
            remove(ref(db, 'positions'));
            remove(ref(db, 'feed'));
            set(ref(db, 'decorVrij'), false);
        }
    };

    function listenToDecorStatus() {
        onValue(ref(db, 'decorVrij'), (snap) => {
            const container = document.getElementById('foto-container');
            if(snap.val() === true) {
                container.classList.remove('unit-view-locked');
            } else {
                if(myRole === 'UNIT') container.classList.add('unit-view-locked');
            }
        });
    }
</script>
</body>
</html>
